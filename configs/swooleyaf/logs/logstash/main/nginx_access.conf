input {
  redis {
    batch_count => 1
    data_type => "list"
    key => "sla00_00001"
    host => "127.0.0.1"
    port => 6688
    password => "yjbn15su"
    db => 2
    threads => 1
  }
}

filter {
  grok {
    match => ["message", "(?<logdate>\S+)\s+(?<savetag1>\S+)\s+(?<client_ip>\S+)\s+(?<server_tag>\S+)"]
  }
  date {
    locale => "en"
    match => ["logdate", "dd/MMM/yyyy:HH:mm:ss"]
  }
  mutate {
    split => ["request_url", "?"]
    add_field => {
        "request_uri" => "%{[request_url][0]}"
    }
    remove_field => ["logdate", "savetag1", "redis_key", "log"]
    convert => {
        "response_status" => "integer"
        "request_time" => "float"
        "upstream_time" => "float"
    }
  }
  if ([response_status] == 200) and ([request_time] < 1.0) {
    ruby {
        code => "
            event.set('message','')
            event.set('create_time',(event.get('@timestamp').to_f.round(3)*1000).to_i)
        "
    }
  } else {
    ruby {
        code => "event.set('create_time',(event.get('@timestamp').to_f.round(3)*1000).to_i)"
    }
  }
}

output {
  # 选择下面其中一个即可
  redis {
    batch => true
    batch_timeout => 3
    data_type => "list"
    host => ["127.0.0.1:6688"]
    password => "yjbn15su"
    db => 2
    key => "sla01_00001"
    codec => "json"
    timeout => 5
    workers => 1
  }
  elasticsearch {
    hosts => "192.168.96.21:9201"
    index => "log-%{+YYYY-MM-dd}"
    user => "elastic"
    password => "jw07061625"
  }
  clickhouse {
    headers => ["Authorization", "Basic YWRtaW46cGFzc3dvcmQxMjM="]
    http_hosts => ["http://127.0.0.1:8123/"]
    table => "default.table"
    request_tolerance => 1 //发生重试前,响应状态码非200的请求次数
    #automatic_retries => 1 //每个host的重试次数
    #backoff_time => 3 //每次重试之间的间隔时间,单位为秒
    #flush_size => 50 //每次提交的数据量
    #idle_flush_time => 5 //每次提交的最大等待时间,单位为秒
  }
  #https://grafana.com/docs/loki/latest/clients/logstash/
  loki {
    url => "http://192.168.96.21:3100/loki/api/v1/push"
  }
}
