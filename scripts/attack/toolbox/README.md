# 介绍
服务器收到攻击时的信息收集脚本,用于排查定位攻击源头

# 检测说明
## 1. 确定进程
```
//查看当前系统运行的进程
ps aux
//查看当前系统运行的进程及父子进程关系
ps auxef
//查看当前系统开启监听的TCP,UDP端口的进程
netstat -tulnp
//查看当前系统所有的网络连接
netstat -anp
//查看当前系统整体运行情况
top -n 1
```

## 2. 确定恶意进程关联文件
```
//查看恶意进程对应的可执行程序
ls -l /proc/pid/exe
//查看恶意进程启动命令
cat /proc/pid/cmdline
//查看与恶意进程关联的文件
lsof -p pid
//查看/tmp、/var/tmp、/dev/shm目录下的可疑文件,特别是以点开头的隐藏文件
ls -alt /tmp
ls -alt /var/tmp
ls -alt /dev/shm
```

## 3. 分析
### 3.1 分析病毒相关的文本文件
尽可能收集多的信息以便后续排查,把获取到的信息写入执行结果

### 3.2 分析脚本文件
了解病毒逻辑,脚本可能是shell,python,perl等,甚至还可能混淆过,如果分析难度太大,可跳过暂不分析

### 3.3 分析二进制程序
用常见的逆向工具如IDA pro分析病毒逻辑,如果分析难度太大,可跳过暂不分析

### 3.4 上传病毒
把二进制病毒上传到virustotal检测,检测病毒是什么类型的病毒

## 4. 确定恶意进程定时任务
```
//查看定时任务的log记录,看是否有异常的定时任务
cat /var/log/cron.log
//病毒特征可以是某个路径或者病毒样本名称,基本上匹配到就可以认为是和病毒有关
//这么操作的原因定时任务和恶意程序之间,可能通过多个脚本关联,比如定时任务执行a.sh,而a.sh调用了b.sh,b.sh调用恶意程序
grep -rn 病毒特征 /etc
grep -rn 病毒特征 /var
grep -rn 病毒特征 /bin
grep -rn 病毒特征 /sbin
```

## 5. 确定恶意进程开机启动项
```
//特别需要关注etc目录下的rc相关目录文件以及init相关目录及文件
ls -alt /etc/init.d
grep -rn 病毒特征 /etc
```

## 6. 清除与恢复
```
//删除恶意定时任务
vim 定时任务文件
//杀死恶意进程
killall -9 进程名
kill -9 pid
//再次确认恶意定时任务是否被删除
vim 定时任务文件
//再次确认恶意进程是否被杀死
ps aux | grep 进程名
//删除恶意开机启动项以及所有和病毒有关联的文件
vim /etc/init.d/*
//如果文件不能被删除,很可能是设置了第二属性,通过chattr -i 文件名 去除不能修改的权限
//如条件允许则重启系统看是否有恶意进程
reboot
```

# 资源
- 参考1: https://github.com/kafroc/emergency-response-toolbox
